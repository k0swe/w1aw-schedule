name: Deploy to Preview Channel

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-and-preview:
    name: Build and Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Cache node deps
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: ${{ runner.os }}-web-${{ hashFiles('web/package-lock.json') }}

      - name: Install npm deps
        working-directory: web
        run: npm ci

      - name: Build
        working-directory: web
        run: npm run build:prod

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to preview channel
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
        run: |
          set +e  # Don't exit immediately on error so we can capture output
          CHANNEL_ID="pr-${{ github.event.pull_request.number }}"
          
          echo "Deploying to channel: $CHANNEL_ID"
          echo "Firebase CLI version:"
          firebase --version
          
          # Deploy to preview channel with JSON output for reliable parsing
          # Note: Not using --only hosting because firebase.json uses "source": "web" (web frameworks)
          # Note: The entire *.web.app domain is manually authorized in Firebase Auth,
          # so all preview channels automatically work with Firebase Authentication.
          # Redirect stderr to a separate file to keep JSON clean
          firebase hosting:channel:deploy $CHANNEL_ID \
            --expires 7d \
            --project w1aw-schedule-76a82 \
            --json > deploy-output.json 2> deploy-errors.txt
          
          DEPLOY_EXIT_CODE=$?
          
          echo "Deploy exit code: $DEPLOY_EXIT_CODE"
          
          # Show any errors from stderr
          if [ -s deploy-errors.txt ]; then
            echo "Deploy errors/warnings:"
            cat deploy-errors.txt
          fi
          
          echo "Deploy output:"
          cat deploy-output.json
          
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "Error: Firebase deploy failed with exit code $DEPLOY_EXIT_CODE"
            exit 1
          fi
          
          # Extract the preview URL from JSON output
          # The file contains build output followed by JSON, so grep from first { onwards
          # The URL is nested under the project ID key
          PREVIEW_URL=$(grep -A 100 '^{' deploy-output.json | jq -r '.result | to_entries | .[0].value.url // empty' 2>/dev/null || echo "")
          
          if [ -z "$PREVIEW_URL" ]; then
            echo "Error: Could not extract preview URL from Firebase output"
            echo "Attempting to parse JSON:"
            grep -A 100 '^{' deploy-output.json | jq '.' 2>/dev/null || echo "Not valid JSON"
            exit 1
          fi
          
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
          echo "‚úÖ Preview URL: $PREVIEW_URL"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = process.env.PREVIEW_URL;
            const commentMarker = '<!-- preview-deployment-comment -->';
            const body = `${commentMarker}
            ### üîç Preview Deploy
            
            Your preview deployment is ready!
            
            **Preview URL:** <a href="${previewUrl}" target="_blank">${previewUrl}</a>
            
            This preview will expire in 7 days.`;
            
            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(comment => 
              comment.body && comment.body.includes(commentMarker)
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              console.log('Updated existing preview comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              console.log('Created new preview comment');
            }

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function loggedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      // Check admin status for the default Colorado event for backward compatibility
      // In multi-event scenarios, this should be checked per-event
      let admins = get(/databases/$(database)/documents/events/jZbFyscc23zjkEGRuPAI).data.admins;
      return request.auth.uid != null && admins != null && request.auth.uid in admins;
    }
    
    function isAdminForEvent(eventId) {
      // Check admin status for a specific event
      let admins = get(/databases/$(database)/documents/events/$(eventId)).data.admins;
      return request.auth.uid != null && admins != null && request.auth.uid in admins;
    }

    // Users may only read their own profile
    match /users/{userId} {
      function usersOwnDoc() {
        return request.auth.uid == userId;
      }
      function notUpdatingStatus() {
        return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'multiShift', 'emailVerified']);
      }

      allow create: if loggedIn() && request.resource.id == request.auth.uid;
      allow read:   if loggedIn() && (usersOwnDoc() || isAdmin());
      allow update: if loggedIn() && (usersOwnDoc() && notUpdatingStatus()) || isAdmin();
      allow delete: if loggedIn() && usersOwnDoc();
      
      // Per-event approval subcollection
      match /eventApprovals/{eventId} {
        function usersOwnApproval() {
          return request.auth.uid == userId;
        }
        function notUpdatingApprovalFields() {
          return !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['status', 'approvedBy', 'declinedBy', 'statusChangedAt']);
        }
        
        // Users can create their own approval application for an event
        allow create: if loggedIn() && usersOwnApproval();
        // Users can read their own approval status
        allow read:   if loggedIn() && (usersOwnApproval() || isAdminForEvent(eventId));
        // Users can update their approval (e.g., appliedAt) but not status fields
        allow update: if loggedIn() && ((usersOwnApproval() && notUpdatingApprovalFields()) || isAdminForEvent(eventId));
        // Users can withdraw their application
        allow delete: if loggedIn() && usersOwnApproval();
      }
    }

    match /events/{eventId} {
      allow read: if true;

      match /shifts/{shiftId} {
        function onlyChangingReservation() {
          return request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['reservedBy', 'reservedDetails']);
        }
        function userIsReservingForThemself() {
          return resource.data.reservedBy == null
            && request.resource.data.reservedBy == request.auth.uid;
        }
        function userAlreadyReserved() {
          return resource.data.reservedBy == request.auth.uid;
        }

        allow read: if loggedIn();
        allow update: if onlyChangingReservation()
          && (userIsReservingForThemself() || userAlreadyReserved())
          || isAdminForEvent(eventId);
      }
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function loggedIn() {
      return request.auth != null;
    }

    function isAdminForEvent(eventId) {
      // Check admin status for a specific event
      let admins = get(/databases/$(database)/documents/events/$(eventId)).data.admins;
      return request.auth.uid != null && admins != null && request.auth.uid in admins;
    }

    // Users may read their own profile or any profile if logged in
    // Admins need to read user profiles when managing event approvals
    match /users/{userId} {
      function usersOwnDoc() {
        return request.auth.uid == userId;
      }
      function notUpdatingStatus() {
        return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['multiShift', 'emailVerified']);
      }

      allow create: if loggedIn() && request.resource.id == request.auth.uid;
      allow read:   if loggedIn();
      allow update: if loggedIn() && usersOwnDoc() && notUpdatingStatus();
      allow delete: if loggedIn() && usersOwnDoc();
    }

    match /events/{eventId} {
      allow read: if true;

      // Per-event approval collection
      match /approvals/{userId} {
        function usersOwnApproval() {
          return request.auth.uid == userId;
        }
        function creatingAppliedStatus() {
          return request.resource.data.status == 'Applied';
        }
        function notUpdatingApprovalFields() {
          return !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['status', 'approvedBy', 'declinedBy', 'statusChangedAt']);
        }

        // Users can create their own approval application (status must be 'Applied')
        allow create: if loggedIn() && usersOwnApproval() && creatingAppliedStatus();
        // Users can read their own approval status, admins can read all approvals for their event
        allow read:   if loggedIn() && (usersOwnApproval() || isAdminForEvent(eventId));
        // Users can update non-protected fields, admins can update all fields
        allow update: if loggedIn() && ((usersOwnApproval() && notUpdatingApprovalFields()) || isAdminForEvent(eventId));
        // Users can withdraw their application
        allow delete: if loggedIn() && usersOwnApproval();
      }

      match /shifts/{shiftId} {
        function onlyChangingReservation() {
          return request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['reservedBy', 'reservedDetails']);
        }
        function userIsReservingForThemself() {
          return resource.data.reservedBy == null
            && request.resource.data.reservedBy == request.auth.uid;
        }
        function userAlreadyReserved() {
          return resource.data.reservedBy == request.auth.uid;
        }

        allow read: if loggedIn();
        allow update: if onlyChangingReservation()
          && (userIsReservingForThemself() || userAlreadyReserved())
          || isAdminForEvent(eventId);
      }
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function loggedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      // Check admin status for the default Colorado event for backward compatibility
      // In multi-event scenarios, this should be checked per-event
      let admins = get(/databases/$(database)/documents/events/jZbFyscc23zjkEGRuPAI).data.admins;
      return request.auth.uid != null && admins != null && request.auth.uid in admins;
    }

    function isAdminForEvent(eventId) {
      // Check admin status for a specific event
      let admins = get(/databases/$(database)/documents/events/$(eventId)).data.admins;
      return request.auth.uid != null && admins != null && request.auth.uid in admins;
    }

    // Users may only read their own profile
    match /users/{userId} {
      function usersOwnDoc() {
        return request.auth.uid == userId;
      }
      function notUpdatingStatus() {
        return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['multiShift', 'emailVerified']);
      }

      allow create: if loggedIn() && request.resource.id == request.auth.uid;
      allow read:   if loggedIn() && (usersOwnDoc() || isAdmin());
      allow update: if loggedIn() && (usersOwnDoc() && notUpdatingStatus()) || isAdmin();
      allow delete: if loggedIn() && usersOwnDoc();
    }

    match /events/{eventId} {
      allow read: if true;

      // Per-event approval collection
      match /approvals/{userId} {
        function usersOwnApproval() {
          return request.auth.uid == userId;
        }
        function creatingAppliedStatus() {
          return request.resource.data.status == 'Applied';
        }
        function notUpdatingApprovalFields() {
          return !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['status', 'approvedBy', 'declinedBy', 'statusChangedAt']);
        }

        // Users can create their own approval application (status must be 'Applied')
        allow create: if loggedIn() && usersOwnApproval() && creatingAppliedStatus();
        // Users can read their own approval status, admins can read all approvals for their event
        allow read:   if loggedIn() && (usersOwnApproval() || isAdminForEvent(eventId));
        // Users can update non-protected fields, admins can update all fields
        allow update: if loggedIn() && ((usersOwnApproval() && notUpdatingApprovalFields()) || isAdminForEvent(eventId));
        // Users can withdraw their application
        allow delete: if loggedIn() && usersOwnApproval();
      }

      match /shifts/{shiftId} {
        function onlyChangingReservation() {
          return request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['reservedBy', 'reservedDetails']);
        }
        function userIsReservingForThemself() {
          return resource.data.reservedBy == null
            && request.resource.data.reservedBy == request.auth.uid;
        }
        function userAlreadyReserved() {
          return resource.data.reservedBy == request.auth.uid;
        }
        function userIsApprovedForEvent() {
          let approval = get(/databases/$(database)/documents/events/$(eventId)/approvals/$(request.auth.uid));
          return approval.data.status == 'Approved';
        }
        function shiftTimeWithinEventBounds() {
          let event = get(/databases/$(database)/documents/events/$(eventId));
          return request.resource.data.time >= event.data.startTime
            && request.resource.data.time < event.data.endTime;
        }
        function shiftTimeOnValidBoundary() {
          let event = get(/databases/$(database)/documents/events/$(eventId));
          let startMillis = event.data.startTime.toMillis();
          let shiftMillis = request.resource.data.time.toMillis();
          let twoHoursInMs = 7200000; // 2 * 60 * 60 * 1000
          // Check if (shiftTime - startTime) is divisible by 2 hours
          return (shiftMillis - startMillis) % twoHoursInMs == 0;
        }
        function validBandAndMode() {
          let validBands = ['2200', '630', '160', '80', '40', '30', '20', '17', '15', '12', '10', '6', '2', '1.25', '0.70', '0.33'];
          let validModes = ['phone', 'cw', 'digital'];
          return request.resource.data.band in validBands
            && request.resource.data.mode in validModes;
        }
        function creatingValidShift() {
          return request.resource.data.keys().hasAll(['time', 'band', 'mode', 'reservedBy', 'reservedDetails'])
            && request.resource.data.reservedBy == request.auth.uid
            && validBandAndMode();
        }

        allow read: if loggedIn();
        allow create: if loggedIn() 
          && (userIsApprovedForEvent() && creatingValidShift() && shiftTimeWithinEventBounds() && shiftTimeOnValidBoundary())
          || isAdminForEvent(eventId);
        allow update: if onlyChangingReservation()
          && (userIsReservingForThemself() || userAlreadyReserved())
          || isAdminForEvent(eventId);
      }
    }
  }
}
